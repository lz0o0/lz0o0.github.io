<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>关于WAF你需要知道什么？ | Le blog de Lz0o0</title>
<meta name="keywords" content="word 1, word 2">
<meta name="description" content="WAF即Web应用防火墙，专门用于保护Web应用服务免受各种网络攻击。区别于传统防火墙，WAF工作在应用层，对Web网站或App业务的HTTP/HTTPS流量进行监测和过滤，通过一系列安全策略和规则来进行恶意特征识别及防护，就像在Web应用周围建立了一道安全屏障。">
<meta name="author" content="Lz0o0">
<link rel="canonical" href="https://lz0o0.github.io/zh/posts/nice-techs/%E5%85%B3%E4%BA%8Ewaf%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%80%E4%B9%88/">



<link crossorigin="anonymous" href="/assets/css/stylesheet.1bbfe75a6db9c99b1388dcf037e3d000ee0e3bb9a25ad7bfbb40b12e7d606ace.css" integrity="" rel="preload stylesheet" as="style">
<link rel="icon" href="https://lz0o0.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://lz0o0.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://lz0o0.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://lz0o0.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://lz0o0.github.io/favicon.ico">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://lz0o0.github.io/zh/posts/nice-techs/%E5%85%B3%E4%BA%8Ewaf%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%80%E4%B9%88/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.7.0/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@1.1.0/dist/Meting.min.js"></script>


<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>
<meta property="og:url" content="https://lz0o0.github.io/zh/posts/nice-techs/%E5%85%B3%E4%BA%8Ewaf%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%80%E4%B9%88/">
  <meta property="og:site_name" content="Le blog de Lz0o0">
  <meta property="og:title" content="关于WAF你需要知道什么？">
  <meta property="og:description" content="WAF即Web应用防火墙，专门用于保护Web应用服务免受各种网络攻击。区别于传统防火墙，WAF工作在应用层，对Web网站或App业务的HTTP/HTTPS流量进行监测和过滤，通过一系列安全策略和规则来进行恶意特征识别及防护，就像在Web应用周围建立了一道安全屏障。">
  <meta property="og:locale" content="zh">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-04-24T13:36:50+08:00">
    <meta property="article:modified_time" content="2025-04-24T13:36:50+08:00">
    <meta property="article:tag" content="技术学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于WAF你需要知道什么？">
<meta name="twitter:description" content="WAF即Web应用防火墙，专门用于保护Web应用服务免受各种网络攻击。区别于传统防火墙，WAF工作在应用层，对Web网站或App业务的HTTP/HTTPS流量进行监测和过滤，通过一系列安全策略和规则来进行恶意特征识别及防护，就像在Web应用周围建立了一道安全屏障。">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "๑✦ˑ_✦",
      "item": "https://lz0o0.github.io/zh/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "关于WAF你需要知道什么？",
      "item": "https://lz0o0.github.io/zh/posts/nice-techs/%E5%85%B3%E4%BA%8Ewaf%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%80%E4%B9%88/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "关于WAF你需要知道什么？",
  "name": "关于WAF你需要知道什么？",
  "description": "WAF即Web应用防火墙，专门用于保护Web应用服务免受各种网络攻击。区别于传统防火墙，WAF工作在应用层，对Web网站或App业务的HTTP/HTTPS流量进行监测和过滤，通过一系列安全策略和规则来进行恶意特征识别及防护，就像在Web应用周围建立了一道安全屏障。",
  "keywords": [
    "word 1", "word 2"
  ],
  "articleBody": "\r1. WAF的定义 WAF全称 Web Application Firewall，即Web应用防火墙，是一种专门用于保护Web应用服务免受各种网络攻击的安全防护工具。在现有网络中，WAF可能作为一个独立的硬件设备安装在网络中，也可能以软件形式作为模块集成到服务器上。随着云化趋势的深度扩展，云化接入、云集成的形式将成为主流发展方向。\n这里看似WAF有多种表现形态，为防止疑惑，有必要重塑一下对于防火墙的理解。所谓的“防火墙”，指的是一个处在外网和内网之间、由软件和硬件设备组合构成的保护屏障，“墙”的概念是一种获取安全性方法的形象说明。也就是说，防火墙本身就是计算机软件和硬件的结合，任何正常的、合规的网络通信和数据包能够通过此“墙”的筛查、过滤，而那些“坏东西”无法穿墙而过。\n了解网络技术最好先对场景有个整体的概念，WAF的工作场景如上图所示（这次试一下Excalidraw的手绘风格）。一般来说需要运营web业务的主体有部署WAF的需求，比如拥有网站服务的一般机构网络、Web服务提供商等。实际中，WAF部署选择会复杂许多，后面会专门介绍。\n区别于传统防火墙，WAF工作在应用层，处于Web业务服务器和客户端（比如，浏览器）之间，对Web网站或App业务的HTTP/HTTPS流量进行监测和过滤，通过一系列安全策略和规则来进行恶意特征识别及防护，就像在Web应用周围建立了一道安全屏障。\n2. WAF需求背景和功能 WAF的出现与传统防火墙的局限相合。传统防火墙主要工作在网络层和传输层，一般主要针对IP地址、端口等进行过滤控制，针对应用层的攻击较难识别，比如无法理解HTTP(s)中的内容，对一些恶意请求（如SQL注入、XSS攻击）无法进行识别。WAF的出现正是为了解决这些问题。\nWAF的推广与Web应用本身的广泛相伴。任何对运营和盈利有需求的网络主体，面临日益复杂的Web应用攻击手段，自然愿意为应用层防护买单，而WAF是一个直接易用的选择。\n那么，WAF的出现是为了解决哪些问题呢？我们试着从攻击者的角度去思考这个问题：假设本鲤作为一个攻击者，我基本的步骤是 “选定目标 → 目标画像 → 漏洞缺陷分析 → 攻击方式 → 发起攻击 → 胜利/失败结算时刻” 。在思考WAF时，不需要全流程的罗列，我们简单关注几个点，重点放在（w/o）WAF的情况下有什么差异即可。\n攻击者选定的目标由大到小大致如下，一般目标越大造成的危害越广泛，收益也越高。在选定目标之后，本鲤自然不会冒失地去搞一些小伎俩，我首先做的就是对目标画像，从多个维度了解目标，尽可能找出他的缺点或弱点，然后伺机而启，一击毙命。因此我会进行网络探测（踩点扫描）、服务版本识别等操作，从多个维度为目标画像，找缺点、弱点。\n全网 \u003e 网络主机 \u003e 主机数据库 \u003e 主机WEB系统管理员 \u003e 主机WEB系统其余用户 一个Web网络的结构如上图所示，我们假设网络的管理者安全意识足够，已经用传统防火墙对Web业务服务器进行了保护。很显然，由于防火墙在网络层和传输层进行了过滤，我们再想用主机发现、端口扫描之类的简单攻击行为就基本无效了，攻击者可能只能获取到Web业务服务域名信息（图中为www.0w0.com），想获得主机相关的IP、端口状态、系统等信息只能在其它层（比如应用层）想想办法。\n首先，可以通过Options、Trace方法探测目标服务域的节点拓扑。如果Web服务器支持这两个方法的话（一般来说，目前安全点的网站都不会允许这两个方法），可以通过检查响应包的Via或Max-forwards字段，得到各个节点的域名。然后，进一步查找对应的IP，尝试对IP直接进行扫描。 如果失败了，可以直接访问服务，检查响应包的Server字段或X-Powered-By字段确定业务域各个节点的http服务器软件版本和脚本语言解释器版本。可能需要扫描页面查看能否获取系统信息，如操作系统类型、版本，开启服务类型等，如有则可进一步查询CVE版本漏洞，并在exploit-db上寻找相应方法攻陷主机。 复杂一些，可以检查有无文件路径遍历，文件包含注入，API注入，命令注入之类的漏洞，来获取整个站点的系统信息甚至获取webshell。或者寻找有无SQL注入、XSS和URL注入等漏洞 —— 总言之，作为攻击者，拥有的武器库非常之丰富强大 理论上，WAF应当针对Web应用的HTTP(s)流量进行安全防护，可能需要支持的功能包括：\n禁止HTTP协议的非安全方法 伪装Web服务的特征 防止API和命令注入防止路径遍历和文件包含注入，对敏感的系统路径进行保护 防止sql注入 防止XSS攻击 防止网页挂马 防护CC攻击 文件上传的防护 动态IP黑名单 白名单 与实时计算平台对接 …… 截至目前，WAF已经进化到WAF3.0，除了常见Web应用攻击的防护外，能够防御CC攻击，还能支持精确防护，进行攻击事件管理等，功能可以说已经十分强大，可以简单看看阿里云WAF3.0的介绍：\n3. WAF发展历程和主要变化 随着 Web 技术的不断演进，WAF 也历经了从 1.0 到 3.0 的发展与变革。WAF 1.0 诞生于传统 Web 时代，基于签名规则应对基础攻击；WAF 2.0 随着 Web 2.0 的兴起而出现，引入动态分析与机器学习优化；如今的 WAF 3.0 则是在黑客利用零日漏洞攻击增多的背景下，以构建正常应用行为模型来实现更全面、更精准的防护，满足现代网络安全需求。\nA. 发展历程 从 WAF 到 WAF 3.0 的发展历程如下：\nWAF 1.0 ：在入侵检测系统 / 入侵防护系统（IDS/IPS）基础上，利用 HTTP 属性和数据转换进行分析，采用基于签名的方法，主要针对服务器攻击，如 SQL 注入、跨站脚本攻击等。 WAF 2.0 ：随着 Web 2.0 技术栈和关键网络应用数量激增，传统基于签名的方法过时，于是引入动态分析方法和监督式机器学习来优化签名列表，同时增加了保护用户免受攻击的方法。 WAF 3.0 ：黑客利用零日漏洞攻击增多，防御者需构建正常应用行为模型来检测异常，WAF 3.0 应运而生，可保护免受零日漏洞攻击，并防止绕过尝试。 B. 主要变化 WAF 从传统版本发展到 3.0，在全方位发生了变革与优化，主要表现在以下四个方面：\n接入方式 ：WAF 3.0 在支持 CNAME 接入和透明接入的基础上，实现了与应用型负载均衡 ALB 等云产品的云原生架构集成，支持云产品接入，还增加了全新的云原生架构接入方式，即通过 SDK 模块化的方式将 WAF 集成在云产品的网关中，避免因额外引入一层转发而带来兼容性和稳定性问题。 防护配置 ：相比 WAF 2.0 为单个域名配置防护规则，WAF 3.0 支持为防护对象或防护对象组配置防护策略，可通过创建防护模板配置防护规则，还支持通过多种方式查看防护规则，以及管理默认防护规则。 功能优化 ：WAF 3.0 取消了规则防护引擎的智能规则托管功能、自定义规则的滑块验证功能等部分功能，但新增了防护模板配置、自定义响应规则、重保场景防护、高级资产中心等功能。 技术应用 ：WAF 3.0 更多地引入了机器学习、人工智能等技术，能够自动学习和识别新的攻击模式，通过对大量网络流量数据进行分析和建模，检测出异常行为和潜在攻击，提供更高级别的防护。 4. WAF的工作原理和流程 Web 应用防火墙（WAF）通过深度检测和过滤 Web 应用的 HTTP/HTTPS 请求与响应，防御常见 Web 攻击。本部分介绍WAF的工作原理、关键模块和大致的工作流程。下图一般WAF的部署方式，直接插入到防火墙后面：\nA. 工作原理 请求检查（全面检查）：WAF 拦截每个传入的 Web 请求，包括请求头、请求体、URL 参数等。检查来源 IP、URL 路径是否异常，是否含特殊字符、SQL 关键字等，还检测请求头（如 User-Agent 字段）是否被篡改。\n规则匹配（预定义规则集）：WAF 内置基于常见 Web 攻击模式（如 SQL 注入、XSS 等）的安全规则。将请求特征与规则匹配，若符合恶意模式（如参数含 XSS 代码），判定为恶意请求。\n防护动作（多样化响应）：根据匹配结果采取防护动作。阻止恶意请求，防止其访问 Web 应用；记录攻击时间、源 IP、类型等信息到日志文件，方便后续分析；向管理员发送警报，提示攻击发生。\nB. WAF 的关键模块 WAF 专注于保护 Web 服务和 Web 应用，能深入分析 HTTP 流量，有效防御多种 Web 攻击。其核心是规则策略模块，能区分正常与恶意流量，并采取相应防护措施。\n入侵检测模块：分析 HTTP 输入输出数据流，识别潜在威胁。 规则策略模块：依据黑白名单、规则集区分正常与恶意流量，是 WAF 的核心依据。 防护模块：在检测到恶意请求时，采取拒绝服务、返回 400 响应页面等防护措施。 C. 工作流程 以请求处理为例，WAF的工作流程大致如下：WAF接收请求 → 请求检查（来源IP、URL路径、特殊字符等；黑白名单、规则集） → 规则匹配（与预定义规则对比；请求解密、头部\u0026内容过规则） → 判断是否恶意请求 → 是 → 防护动作（阻止请求、记录日志、报警） → 否 → 请求继续处理。\n在处理过程中采取的操作可能包括直接放行（比如匹配到URL白名单，直接放行至Web服务器）、关卡放行（进入下一检测关卡），以及丢弃、拒绝、重定向、暂停（对于暴力攻击）、代理导流（如蜜罐）。\nWAF同样会对响应作一定处理，但相比请求要简单许多。下图是WAF处理过程的工作流示意：\n5. WAF的部署模式 随着网络安全需求的不断演进和技术的持续创新，WAF的部署经历了一定的发展变化。早期的反向代理、透明代理和旁路监控等传统模式，与如今云原生的架构进行了融合，WAF的部署方式变得更加灵活、高效且适应性强。这些变化能够提升WAF在复杂网络环境中的适用性和性能表现，极大简化部署和管理流程，使其能够更好地满足现代企业对Web应用安全防护的多样化需求。\n此前提到，在现有网络中，WAF可能作为一个独立的硬件设备安装在网络中，也可能以软件形式作为模块集成到服务器上。随着云化趋势的深度扩展，云化接入、云集成的形式或将成为主流。云化并未根本改变WAF部署的模式结构，而是将此前的部署模式与云场景、云部署进行了融合。\nA. WAF的主流部署模式 WAF一般支持透明代理、反向代理和旁路监控模式，三种部署模式从网络结构上存在明显的区别。\n透明代理串接模式 ：将WAF串接在网络中，实现即插即用，无需更改网络设备与服务器配置。其优点是部署简单、对网络结构无影响、安全防护性能强、故障恢复快可支持Bypass；缺点是对网络的依赖性较强，若网络出现故障可能会影响WAF的正常工作。 反向代理模式 ：早期WAF多采用此模式，其部署在Web服务器前端，客户端请求先经过WAF，由WAF代为转发请求到后端服务器，再将服务器的响应返回给客户端。优点是部署相对简单，且能有效隐藏后端服务器地址等信息，对服务器有较好的保护作用；缺点是可能会成为性能瓶颈，且需要更改网络配置，故障恢复相对较慢。具体可细分为代理模式和牵引模式，主要区别在于映射转发的位置。 旁路监控模式 ：通过在交换机上做服务器端口镜像，将流量复制一份到WAF上，WAF仅对流量进行监控和告警而不阻断，部署时不影响在线业务。此模式优点是不影响现有网络业务，可作为安全监测手段；缺点是无法直接对攻击流量进行阻断，只能起到事后分析的作用。\nB. 当前主流接入方式 当前主流的 WAF 接入方式各有特点，分别为 CNAME 接入、云产品接入和云原生架构接入。CNAME 接入操作简单，适合大多数网站业务，修改通过域名 DNS 解析实现引流；云产品接入则适用于阿里云用户，在云产品控制台添加引流端口到 WAF，无需修改 DNS，降低了配置复杂度；云原生架构接入是 WAF 3.0 的特有方式，采用 SDK 模块化集成，避免流量转发带来的兼容性问题，提升业务性能，简化接入流程。\nCNAME接入（反向代理模式）：CNAME 接入是通过将域名的 DNS 解析指向 WAF 提供的 CNAME 地址，使 Web 业务流量被引流到 WAF。WAF 作为反向代理集群，拦截攻击请求并将正常业务请求转发回源站服务器。它适用于大多数网站的 Web 业务，操作相对简单，只需修改域名的 DNS 解析设置，可以有效隐藏源站 IP，便于集中管理多个域名的流量并实施统一的安全策略。 云产品接入（透明代理模式）：云产品接入是通过在云产品控制台（如阿里云的 ALB 等）添加引流端口到 WAF，使云产品网关自动改变路由，将 Web 业务流量引导至 WAF。WAF 进行攻击拦截并转发正常请求回源站。它适用于使用阿里云云产品的用户，无需修改 DNS，降低了配置复杂度，减少了因 DNS 变更可能带来的流量中断风险，该接入适合与云平台应用产品紧密集成的场景。 云原生架构集成接入：这是WAF部署模式的重要发展方向，以阿里云WAF 3.0为代表。采用 SDK 模块化的方式将 WAF 集成到云产品的网关中，内嵌在网关中的 SDK 提取流量并进行检测和防护，WAF 不直接参与流量转发。它适合对业务性能和稳定性要求较高的场景，尤其是当用户已在使用阿里云的云产品且希望通过更高效的方式实现安全防护时。这种方式避免了因额外引入 WAF 转发层而可能产生的兼容性和稳定性问题，提升了业务性能，简化了接入流程，降低了对用户业务的影响。 6. WAF vs 其它 WAF的功能，免不了要与传统安全设备如IDS和IPS有所对比，但从WAF的出现和发展，俨然就是一个“专项特种兵”的模板，因此有其独特优势的同时，短板和局限也是十分明显的。\nA. WAF 与其他网络安全设备的对比 传统防火墙：工作在网络层和传输层，侧重源地址、目的地址和端口号的初步检测，无法深入分析 HTTP 流量。 入侵检测系统（IDS）：部署在内部网络，监控网络安全状况，侧重检测和审计，无法主动防御。 入侵防御系统（IPS）：基于签名数据库和策略来检查已知漏洞和攻击，适用于保护多种网络协议，但不专用于 HTTP 流量。 B. WAF 的价值与优势 深度防御：工作在应用层，能够审计所有 HTTP 流量，提供比传统设备更深入的 Web 应用保护。 灵活性：可以快速修改规则策略，及时应对不断变化的攻击。 速率限制：能够快速实施速率限制，有效防止 DDoS 攻击。 C. WAF 的局限 协议局限：WAF主要针对HTTP/HTTPS协议，无法过滤其他协议（如FTP、PoP3）的流量。 功能局限：无法实现传统防火墙的功能，如地址映射、端口转发等网络层和传输层操作。 攻击局限：主要针对应用层攻击，由于难以理解复杂业务逻辑，无法识别如恶意利用优惠券、外挂抢购等业务逻辑攻击，也无法防御零日攻击和部分复杂的应用层攻击。 防护局限：不具备防病毒功能，无法检测和清除终端设备上的病毒和恶意软件。 误报和漏报：尽管是共性问题，但WAF中部署模式的影响可能比较明显。 性能开销：对HTTP流量的深度检查和过滤会增加请求处理时间，导致延迟，且在处理大量流量时会消耗较多系统资源，影响Web应用性能。 配置和管理复杂：需要专业知识和经验来合理配置规则，过于严格或宽松都会影响效果，且需要定期更新规则以应对新的攻击方式，增加了维护成本。 7. 主流供应厂商和WAF产品 目前市场上的WAF产品种类繁多，涵盖了云WAF、硬件WAF和软件WAF等多种部署模式。云WAF产品如AWS WAF、Akamai Kona Site Defender、Fortinet FortiWeb、Cloudflare WAF等，具有部署便捷、易于扩展和集成等优势，适合各类企业使用。硬件WAF产品如安恒明御Web应用防火墙、长亭雷池(SafeLine)等，适合对安全性要求较高的企业。软件WAF产品如网站安全狗、云锁等，适合中小企业和开发者。各厂商不断推出创新产品和解决方案，以满足不同用户的需求。\n下表是目前比较主流的WAF供应厂商和产品线（这部分借助kimi整理）：\n公司名称 简述 国内 深信服 国内领先的网络安全解决方案提供商，WAF 产品简单易用、高效防护，广泛应用于各类企业及机构。 绿盟科技 提供硬件 WAF 产品，在网络入侵防护领域技术深厚，能有效应对各类 Web 攻击。 启明星辰 国内知名网络安全企业，硬件 WAF 产品防护能力强、功能丰富，满足金融、能源等行业需求。 安恒信息 国内网络安全佼佼者，天穹 Web 应用防火墙硬件产品，提供多方位安全防护服务。 腾讯云 提供云 WAF 服务，具备强大 Web 攻击检测能力，支持多种架构及接入方式，满足多行业需求。 阿里云 云 WAF 结合多种云服务交付，市场占有率高，提供全面防护功能及灵活付费模式。 国外 Fortinet 提供硬件和软件形式的 WAF 解决方案，其 FortiWeb 产品采用多层安全方法，防止已知和未知攻击，保护 Web 应用程序和 API，支持物理设备、虚拟机、云实例和容器等多种部署方式。 Imperva 提供全面网络安全解决方案，WAF 产品及服务防护能力强、功能丰富，应用于全球大型企业。 Cloudflare 全球知名云服务提供商，WAF 服务集成于云平台，具备强大 DDoS 防护及 Web 攻击防护功能。 Akamai 提供软件和托管服务形式的 WAF 解决方案，依托全球分布式网络，保障 Web 应用可用性和安全性。 F5（CloudGuard） 提供高性能硬件 WAF 设备和软件解决方案，在应用交付和安全领域经验丰富，提供高级防护。 Barracuda Networks 提供多种形式的 WAF 解决方案，产品易用且高效，可有效保护 Web 应用免受多种攻击威胁。 厂商 产品 部署模式 核心能力 AWS AWS WAF 基于云 基于云的WAF解决方案，与AWS服务集成，提供可扩展和灵活的保护，实时威胁检测和阻止，可自定义规则和策略 Akamai Kona Site Defender 基于云 提供企业级保护，高级DDoS保护，实时威胁检测和阻止，与Akamai的CDN集成以改善性能，全面的报告和分析 Fortinet FortiWeb 硬件或虚拟 基于AI的威胁检测和阻止，提供硬件和虚拟解决方案，机器人保护和DDoS缓解，全面的报告和分析 Cloudflare Cloudflare WAF 基于云 提供低延迟、高可用、高可扩展的防护能力，可防止OWASP Top 10等常见攻击，可根据用户自定义规则和Cloudflare智能规则进行灵活配置，可与其他服务集成 ModSecurity ModSecurity WAF 主机层 开源免费，灵活配置，支持多种协议和格式的分析和过滤，可使用OWASP Core Rule Set等标准规则集，也可使用用户自定义规则，还可与其他工具集成 阿里云 阿里云WAF 基于云 提供基于云计算的Web应用防火墙，保护Web应用免受常见黑客攻击技术和安全漏洞的侵害 腾讯云 T-Sec WAF 基于云 提供Web应用防火墙服务，具备Web安全防护和Web威胁智能拦截功能 华为云 Web应用防火墙 WAF 基于云 提供Web应用防火墙服务，保护Web应用的安全 安恒信息 玄武盾 基于云 提供云防护平台，具备Web应用防火墙功能 百度智能云 云应用防火墙 WAF 基于云 提供应用防火墙服务，具备安全漏洞防护和云安全应用防护功能 知道创宇 创宇盾 基于云 提供Web应用防火墙服务，具备政企网站防护、被黑防护、防篡改等功能 F5 分布式云 WAF 基于云 提供分布式云WAF服务 奇安信 网站卫士 基于云 提供Web应用安全防护服务 360 磐云 基于云 提供Web应用防火墙服务 网宿科技 Web应用防火墙 基于云 提供Web应用防火墙服务，具备网站防护和智能边缘安全功能 深信服 云Web应用防火墙 基于云 提供云WAF服务，具备Bot防护和云安全功能 绿盟科技 网站云防护 基于云 提供云计算安全产品，具备网站云防护功能 启明星辰 虚拟化WAF 虚拟化 提供虚拟WAF服务，具备Web应用安全网关功能 长亭科技 雷池(SafeLine) 硬件 下一代Web应用防火墙，提供Web应用防护功能 天融信 Web应用安全防护系统(TopWAF) 硬件 提供Web应用安全防护系统服务 瑞数信息 动态Web应用防火墙（River Safeplus） 硬件 提供动态Web应用防火墙服务 写在最后 本质上，WAF作为一种专用网络安全技术，在安全防御体系中需要承担特定的责任。用现实世界中安防机构的安防全景图来类比，WAF比较类似一个大门入口处智能安检系统的角色，负责检查进入Web应用的“人员”（HTTP请求），并拦截可疑行为（如SQL注入、XSS攻击）。\n关于安防机构的全景图，我简单设想了一个分层比喻的对应情况，便于理解WAF的角色定位：\n外部防御层：防火墙（围墙+安检门）+ VPN（加密电梯） 入口过滤层：WAF（智能安检系统） 内部监测层：IDS（摄像头）+ IPS（安保人员）+ HIDS（保镖） 数据保护层：加密技术（保险柜）+ 网络隔离（防火分区） 高级防护层：蜜罐（诱饵房间）+ 零信任（人脸识别门禁）+ SIEM（指挥中心） Refer WAF相关专栏： 安全文章相关\nWAF的部署方式 - 知乎\n什么是Web应用防火墙，简称：WAF（Web Application Firewall）_waf应用安全网关是什么-CSDN博客\nWAF（Web应用防火墙）的关键技术分析_waf路由模式-CSDN博客\nWAF 2.0和WAF 3.0是什么关系、有什么区别、如何快速使用_Web应用防火墙(WAF)-阿里云帮助中心\nWAF基本原理与部署方式，建议收藏！ - FreeBuf网络安全行业门户\nKimi：Kimi - 会推理解析，能深度思考的AI助手\n",
  "wordCount" : "8140",
  "inLanguage": "zh",
  "datePublished": "2025-04-24T13:36:50+08:00",
  "dateModified": "2025-04-24T13:36:50+08:00",
  "author":[{
    "@type": "Person",
    "name": "Lz0o0"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://lz0o0.github.io/zh/posts/nice-techs/%E5%85%B3%E4%BA%8Ewaf%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E4%BB%80%E4%B9%88/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Le blog de Lz0o0",
    "logo": {
      "@type": "ImageObject",
      "url": "https://lz0o0.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://lz0o0.github.io/zh/" accesskey="h" title="Le blog de Lz0o0 (Alt + H)">Le blog de Lz0o0</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://lz0o0.github.io/zh/search" title="🔍Search (Alt &#43; /)" accesskey=/>
                    <span>🔍Search</span>
                </a>
            </li>
            <li>
                <a href="https://lz0o0.github.io/zh/" title="🏠Home">
                    <span>🏠Home</span>
                </a>
            </li>
            <li>
                <a href="https://lz0o0.github.io/zh/posts" title="📓Blogs">
                    <span>📓Blogs</span>
                </a>
            </li>
            <li>
                <a href="https://lz0o0.github.io/zh/tags" title="🔖tags">
                    <span>🔖tags</span>
                </a>
            </li>
            <li>
                <a href="https://lz0o0.github.io/zh/archive" title="⏱archives">
                    <span>⏱archives</span>
                </a>
            </li>
            <li>
                <a href="https://lz0o0.github.io/zh/links" title="🤝links">
                    <span>🤝links</span>
                </a>
            </li>
            <li>
                <a href="https://lz0o0.github.io/zh/about" title="😎about">
                    <span>😎about</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://lz0o0.github.io/zh/">🏠Home</a>&nbsp;»&nbsp;<a href="https://lz0o0.github.io/zh/posts/">๑✦ˑ_✦</a></div>
    <h1 class="post-title entry-hint-parent">
      关于WAF你需要知道什么？
    </h1>
    <div class="post-meta"><span title='2025-04-24 13:36:50 +0800 CST'>2025-04-24</span>&nbsp;·&nbsp;17 mins&nbsp;·&nbsp;Lz0o0

</div>
  </header>

  
  <div class="post-tags">
      <ul class="post-tags">
        <li><a href="https://lz0o0.github.io/zh/tags/%E6%8A%80%E6%9C%AF%E5%AD%A6%E4%B9%A0/">技术学习</a></li>
      </ul>
  </div> 
  
  <div class="toc-container"><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Directory</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#1-waf%e7%9a%84%e5%ae%9a%e4%b9%89" aria-label="1. WAF的定义">1. WAF的定义</a></li>
                <li>
                    <a href="#2-waf%e9%9c%80%e6%b1%82%e8%83%8c%e6%99%af%e5%92%8c%e5%8a%9f%e8%83%bd" aria-label="2. WAF需求背景和功能">2. WAF需求背景和功能</a></li>
                <li>
                    <a href="#3-waf%e5%8f%91%e5%b1%95%e5%8e%86%e7%a8%8b%e5%92%8c%e4%b8%bb%e8%a6%81%e5%8f%98%e5%8c%96" aria-label="3. WAF发展历程和主要变化">3. WAF发展历程和主要变化</a><ul>
                        <ul>
                        
                <li>
                    <a href="#a-%e5%8f%91%e5%b1%95%e5%8e%86%e7%a8%8b" aria-label="A. 发展历程">A. 发展历程</a></li>
                <li>
                    <a href="#b-%e4%b8%bb%e8%a6%81%e5%8f%98%e5%8c%96" aria-label="B. 主要变化">B. 主要变化</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#4-waf%e7%9a%84%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86%e5%92%8c%e6%b5%81%e7%a8%8b" aria-label="4. WAF的工作原理和流程">4. WAF的工作原理和流程</a><ul>
                        <ul>
                        
                <li>
                    <a href="#a-%e5%b7%a5%e4%bd%9c%e5%8e%9f%e7%90%86" aria-label="A. 工作原理">A. 工作原理</a></li>
                <li>
                    <a href="#b-waf-%e7%9a%84%e5%85%b3%e9%94%ae%e6%a8%a1%e5%9d%97" aria-label="B. WAF 的关键模块">B. WAF 的关键模块</a></li>
                <li>
                    <a href="#c-%e5%b7%a5%e4%bd%9c%e6%b5%81%e7%a8%8b" aria-label="C. 工作流程">C. 工作流程</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#5-waf%e7%9a%84%e9%83%a8%e7%bd%b2%e6%a8%a1%e5%bc%8f" aria-label="5. WAF的部署模式">5. WAF的部署模式</a><ul>
                        <ul>
                        
                <li>
                    <a href="#a-waf%e7%9a%84%e4%b8%bb%e6%b5%81%e9%83%a8%e7%bd%b2%e6%a8%a1%e5%bc%8f" aria-label="A. WAF的主流部署模式">A. WAF的主流部署模式</a></li>
                <li>
                    <a href="#b-%e5%bd%93%e5%89%8d%e4%b8%bb%e6%b5%81%e6%8e%a5%e5%85%a5%e6%96%b9%e5%bc%8f" aria-label="B. 当前主流接入方式">B. 当前主流接入方式</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#6-waf-vs-%e5%85%b6%e5%ae%83" aria-label="6. WAF vs 其它">6. WAF vs 其它</a><ul>
                        <ul>
                        
                <li>
                    <a href="#a-waf-%e4%b8%8e%e5%85%b6%e4%bb%96%e7%bd%91%e7%bb%9c%e5%ae%89%e5%85%a8%e8%ae%be%e5%a4%87%e7%9a%84%e5%af%b9%e6%af%94" aria-label="A. WAF 与其他网络安全设备的对比">A. WAF 与其他网络安全设备的对比</a></li>
                <li>
                    <a href="#b-waf-%e7%9a%84%e4%bb%b7%e5%80%bc%e4%b8%8e%e4%bc%98%e5%8a%bf" aria-label="B. WAF 的价值与优势">B. WAF 的价值与优势</a></li>
                <li>
                    <a href="#c-waf-%e7%9a%84%e5%b1%80%e9%99%90" aria-label="C. WAF 的局限">C. WAF 的局限</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#7-%e4%b8%bb%e6%b5%81%e4%be%9b%e5%ba%94%e5%8e%82%e5%95%86%e5%92%8cwaf%e4%ba%a7%e5%93%81" aria-label="7. 主流供应厂商和WAF产品">7. 主流供应厂商和WAF产品</a></li>
                <li>
                    <a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%90%8e" aria-label="写在最后">写在最后</a></li>
                <li>
                    <a href="#refer" aria-label="Refer">Refer</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  </div>
  <div class="post-content"><!-- more -->
<h3 id="1-waf的定义">1. WAF的定义<a hidden class="anchor" aria-hidden="true" href="#1-waf的定义">#</a></h3>
<p>  WAF全称 Web Application Firewall，即Web应用防火墙，是一种专门用于保护Web应用服务免受各种网络攻击的安全防护工具。在现有网络中，WAF可能作为一个独立的硬件设备安装在网络中，也可能以软件形式作为模块集成到服务器上。随着云化趋势的深度扩展，云化接入、云集成的形式将成为主流发展方向。</p>
<p>  这里看似WAF有多种表现形态，为防止疑惑，有必要重塑一下对于防火墙的理解。所谓的“防火墙”，指的是一个处在外网和内网之间、由软件和硬件设备组合构成的保护屏障，“墙”的概念是一种获取安全性方法的形象说明。也就是说，防火墙本身就是计算机软件和硬件的结合，任何正常的、合规的网络通信和数据包能够通过此“墙”的筛查、过滤，而那些“坏东西”无法穿墙而过。</p>
<img src="https://lizhuo.space/WAF-case.png" alt="WAF工作场景拓扑" style="zoom:80%;" />
<p>  了解网络技术最好先对场景有个整体的概念，WAF的工作场景如上图所示（这次试一下Excalidraw的手绘风格）。一般来说需要运营web业务的主体有部署WAF的需求，比如拥有网站服务的一般机构网络、Web服务提供商等。实际中，WAF部署选择会复杂许多，后面会专门介绍。</p>
<p>  区别于传统防火墙，WAF工作在应用层，处于Web业务服务器和客户端（比如，浏览器）之间，对Web网站或App业务的HTTP/HTTPS流量进行监测和过滤，通过一系列安全策略和规则来进行恶意特征识别及防护，就像在Web应用周围建立了一道安全屏障。</p>
<hr>
<h3 id="2-waf需求背景和功能">2. WAF需求背景和功能<a hidden class="anchor" aria-hidden="true" href="#2-waf需求背景和功能">#</a></h3>
<p>  <strong>WAF的出现与传统防火墙的局限相合</strong>。传统防火墙主要工作在网络层和传输层，一般主要针对IP地址、端口等进行过滤控制，针对应用层的攻击较难识别，比如无法理解HTTP(s)中的内容，对一些恶意请求（如SQL注入、XSS攻击）无法进行识别。WAF的出现正是为了解决这些问题。</p>
<p>  <strong>WAF的推广与Web应用本身的广泛相伴</strong>。任何对运营和盈利有需求的网络主体，面临日益复杂的Web应用攻击手段，自然愿意为应用层防护买单，而WAF是一个直接易用的选择。</p>
<p>  <strong>那么，WAF的出现是为了解决哪些问题呢</strong>？我们试着从攻击者的角度去思考这个问题：假设本鲤作为一个攻击者，我基本的步骤是 “选定目标 → 目标画像 → 漏洞缺陷分析 → 攻击方式 → 发起攻击 → 胜利/失败结算时刻” 。在思考WAF时，不需要全流程的罗列，我们简单关注几个点，重点放在（w/o）WAF的情况下有什么差异即可。</p>
<p>  攻击者选定的目标由大到小大致如下，一般目标越大造成的危害越广泛，收益也越高。在选定目标之后，本鲤自然不会冒失地去搞一些小伎俩，我首先做的就是对目标画像，从多个维度了解目标，尽可能找出他的缺点或弱点，然后伺机而启，一击毙命。因此我会进行网络探测（踩点扫描）、服务版本识别等操作，从多个维度为目标画像，找缺点、弱点。</p>
<blockquote>
<p><font size=3>全网 &gt; 网络主机 &gt; 主机数据库 &gt; 主机WEB系统管理员 &gt; 主机WEB系统其余用户 </font></p></blockquote>
<img src="https://lizhuo.space/without-WAF.png" alt="Web网络结构示意" style="zoom: 60%;" />
<p>  一个Web网络的结构如上图所示，我们假设网络的管理者安全意识足够，已经用传统防火墙对Web业务服务器进行了保护。很显然，由于防火墙在网络层和传输层进行了过滤，我们再想用主机发现、端口扫描之类的简单攻击行为就基本无效了，攻击者可能只能获取到Web业务服务域名信息（图中为www.0w0.com），想获得主机相关的IP、端口状态、系统等信息只能在其它层（比如应用层）想想办法。</p>
<ul>
<li>首先，可以通过Options、Trace方法探测目标服务域的节点拓扑。如果Web服务器支持这两个方法的话（一般来说，目前安全点的网站都不会允许这两个方法），可以通过检查响应包的Via或Max-forwards字段，得到各个节点的域名。然后，进一步查找对应的IP，尝试对IP直接进行扫描。</li>
</ul>
<img src="https://lizhuo.space/option-trace-gettopo.png" alt="Web服务器不支持：以本站为例" style="zoom: 50%;" />
<ul>
<li>如果失败了，可以直接访问服务，检查响应包的<strong>Server字段或X-Powered-By字段</strong>确定业务域各个节点的http服务器软件版本和脚本语言解释器版本。可能需要扫描页面查看能否获取系统信息，如操作系统类型、版本，开启服务类型等，如有则可进一步查询CVE版本漏洞，并在exploit-db上寻找相应方法攻陷主机。</li>
<li>复杂一些，可以检查有无<strong>文件路径遍历，文件包含注入，API注入，命令注入</strong>之类的漏洞，来获取整个站点的系统信息甚至获取webshell。或者寻找有无SQL注入、XSS和URL注入等漏洞 —— <strong>总言之，作为攻击者，拥有的武器库非常之丰富强大</strong></li>
</ul>
<p>  理论上，WAF应当针对Web应用的HTTP(s)流量进行安全防护，可能需要支持的功能包括：</p>
<blockquote>
<ul>
<li><font size=3>禁止HTTP协议的非安全方法</font></li>
<li><font size=3>伪装Web服务的特征</font></li>
<li><font size=3>防止API和命令注入防止路径遍历和文件包含注入，对敏感的系统路径进行保护</font></li>
<li><font size=3>防止sql注入</font></li>
<li><font size=3>防止XSS攻击</font></li>
<li><font size=3>防止网页挂马 </font></li>
<li><font size=3>防护CC攻击</font></li>
<li><font size=3>文件上传的防护</font></li>
<li><font size=3>动态IP黑名单</font></li>
<li><font size=3>白名单</font></li>
<li><font size=3>与实时计算平台对接</font></li>
<li><font size=3>&hellip;&hellip;</font></li>
</ul></blockquote>
<p>  截至目前，WAF已经进化到WAF3.0，除了常见Web应用攻击的防护外，能够防御CC攻击，还能支持精确防护，进行攻击事件管理等，功能可以说已经十分强大，可以简单看看<a href="https://help.aliyun.com/zh/waf/web-application-firewall-3-0/product-overview/what-is-waf">阿里云WAF3.0</a>的介绍：</p>
<img src="https://lizhuo.space/alyun-WAF3.png" alt="阿里云WAF3.0" style="zoom: 100%;" />
<hr>
<h3 id="3-waf发展历程和主要变化">3. WAF发展历程和主要变化<a hidden class="anchor" aria-hidden="true" href="#3-waf发展历程和主要变化">#</a></h3>
<p>  随着 Web 技术的不断演进，WAF 也历经了从 1.0 到 3.0 的发展与变革。WAF 1.0 诞生于传统 Web 时代，基于签名规则应对基础攻击；WAF 2.0 随着 Web 2.0 的兴起而出现，引入动态分析与机器学习优化；如今的 WAF 3.0 则是在黑客利用零日漏洞攻击增多的背景下，以构建正常应用行为模型来实现更全面、更精准的防护，满足现代网络安全需求。</p>
<h5 id="a-发展历程">A. 发展历程<a hidden class="anchor" aria-hidden="true" href="#a-发展历程">#</a></h5>
<p>  从 WAF 到 WAF 3.0 的发展历程如下：</p>
<ul>
<li><strong>WAF 1.0</strong> ：在入侵检测系统 / 入侵防护系统（IDS/IPS）基础上，利用 HTTP 属性和数据转换进行分析，采用基于签名的方法，主要针对服务器攻击，如 SQL 注入、跨站脚本攻击等。</li>
<li><strong>WAF 2.0</strong> ：随着 Web 2.0 技术栈和关键网络应用数量激增，传统基于签名的方法过时，于是引入动态分析方法和监督式机器学习来优化签名列表，同时增加了保护用户免受攻击的方法。</li>
<li><strong>WAF 3.0</strong> ：黑客利用零日漏洞攻击增多，防御者需构建正常应用行为模型来检测异常，WAF 3.0 应运而生，可保护免受零日漏洞攻击，并防止绕过尝试。</li>
</ul>
<h5 id="b-主要变化">B. 主要变化<a hidden class="anchor" aria-hidden="true" href="#b-主要变化">#</a></h5>
<p>  WAF 从传统版本发展到 3.0，在全方位发生了变革与优化，主要表现在以下四个方面：</p>
<ul>
<li><strong>接入方式</strong> ：WAF 3.0 在支持 CNAME 接入和透明接入的基础上，实现了与应用型负载均衡 ALB 等云产品的云原生架构集成，支持云产品接入，还增加了全新的云原生架构接入方式，即通过 SDK 模块化的方式将 WAF 集成在云产品的网关中，避免因额外引入一层转发而带来兼容性和稳定性问题。</li>
<li><strong>防护配置</strong> ：相比 WAF 2.0 为单个域名配置防护规则，WAF 3.0 支持为防护对象或防护对象组配置防护策略，可通过创建防护模板配置防护规则，还支持通过多种方式查看防护规则，以及管理默认防护规则。</li>
<li><strong>功能优化</strong> ：WAF 3.0 取消了规则防护引擎的智能规则托管功能、自定义规则的滑块验证功能等部分功能，但新增了防护模板配置、自定义响应规则、重保场景防护、高级资产中心等功能。</li>
<li><strong>技术应用</strong> ：WAF 3.0 更多地引入了机器学习、人工智能等技术，能够自动学习和识别新的攻击模式，通过对大量网络流量数据进行分析和建模，检测出异常行为和潜在攻击，提供更高级别的防护。</li>
</ul>
<hr>
<h3 id="4-waf的工作原理和流程">4. WAF的工作原理和流程<a hidden class="anchor" aria-hidden="true" href="#4-waf的工作原理和流程">#</a></h3>
<p>  Web 应用防火墙（WAF）通过深度检测和过滤 Web 应用的 HTTP/HTTPS 请求与响应，防御常见 Web 攻击。本部分介绍WAF的工作原理、关键模块和大致的工作流程。下图一般WAF的部署方式，直接插入到防火墙后面：</p>
<img src="https://lizhuo.space/with-WAF.png" alt="WAF应用场景" style="zoom: 67%;" />
<h5 id="a-工作原理">A. 工作原理<a hidden class="anchor" aria-hidden="true" href="#a-工作原理">#</a></h5>
<ul>
<li>
<p>请求检查（<strong>全面检查</strong>）：WAF 拦截每个传入的 Web 请求，包括请求头、请求体、URL 参数等。检查来源 IP、URL 路径是否异常，是否含特殊字符、SQL 关键字等，还检测请求头（如 User-Agent 字段）是否被篡改。</p>
</li>
<li>
<p>规则匹配（<strong>预定义规则集</strong>）：WAF 内置基于常见 Web 攻击模式（如 SQL 注入、XSS 等）的安全规则。将请求特征与规则匹配，若符合恶意模式（如参数含 XSS 代码），判定为恶意请求。</p>
</li>
<li>
<p>防护动作（<strong>多样化响应</strong>）：根据匹配结果采取防护动作。阻止恶意请求，防止其访问 Web 应用；记录攻击时间、源 IP、类型等信息到日志文件，方便后续分析；向管理员发送警报，提示攻击发生。</p>
</li>
</ul>
<h5 id="b-waf-的关键模块">B. WAF 的关键模块<a hidden class="anchor" aria-hidden="true" href="#b-waf-的关键模块">#</a></h5>
<p>  WAF 专注于保护 Web 服务和 Web 应用，能深入分析 HTTP 流量，有效防御多种 Web 攻击。其核心是规则策略模块，能区分正常与恶意流量，并采取相应防护措施。</p>
<blockquote>
<ul>
<li><strong>入侵检测模块</strong>：分析 HTTP 输入输出数据流，识别潜在威胁。</li>
<li><strong>规则策略模块</strong>：依据黑白名单、规则集区分正常与恶意流量，是 WAF 的核心依据。</li>
<li><strong>防护模块</strong>：在检测到恶意请求时，采取拒绝服务、返回 400 响应页面等防护措施。</li>
</ul></blockquote>
<h5 id="c-工作流程">C. 工作流程<a hidden class="anchor" aria-hidden="true" href="#c-工作流程">#</a></h5>
<p>  以请求处理为例，WAF的工作流程大致如下：WAF接收请求 → 请求检查（来源IP、URL路径、特殊字符等；黑白名单、规则集） → 规则匹配（与预定义规则对比；请求解密、头部&amp;内容过规则） → 判断是否恶意请求 → 是 → 防护动作（阻止请求、记录日志、报警） → 否 → 请求继续处理。</p>
<p>  在处理过程中采取的操作可能包括直接放行（比如匹配到URL白名单，直接放行至Web服务器）、关卡放行（进入下一检测关卡），以及丢弃、拒绝、重定向、暂停（对于暴力攻击）、代理导流（如蜜罐）。</p>
<p>  WAF同样会对响应作一定处理，但相比请求要简单许多。下图是WAF处理过程的工作流示意：</p>
<p><img alt="WAF处理工作流" loading="lazy" src="https://lizhuo.space/workflows-WAF.png"></p>
<hr>
<h3 id="5-waf的部署模式">5. WAF的部署模式<a hidden class="anchor" aria-hidden="true" href="#5-waf的部署模式">#</a></h3>
<p>  随着网络安全需求的不断演进和技术的持续创新，WAF的部署经历了一定的发展变化。早期的反向代理、透明代理和旁路监控等传统模式，与如今云原生的架构进行了融合，WAF的部署方式变得更加灵活、高效且适应性强。这些变化能够提升WAF在复杂网络环境中的适用性和性能表现，极大简化部署和管理流程，使其能够更好地满足现代企业对Web应用安全防护的多样化需求。</p>
<p>  此前提到，在现有网络中，WAF可能作为一个独立的硬件设备安装在网络中，也可能以软件形式作为模块集成到服务器上。随着云化趋势的深度扩展，云化接入、云集成的形式或将成为主流。云化并未根本改变WAF部署的模式结构，而是将此前的部署模式与云场景、云部署进行了融合。</p>
<h5 id="a-waf的主流部署模式">A. WAF的主流部署模式<a hidden class="anchor" aria-hidden="true" href="#a-waf的主流部署模式">#</a></h5>
<p>  WAF一般支持透明代理、反向代理和旁路监控模式，三种部署模式从网络结构上存在明显的区别。</p>
<ul>
<li><strong>透明代理串接模式</strong> ：将WAF串接在网络中，实现即插即用，无需更改网络设备与服务器配置。其优点是部署简单、对网络结构无影响、安全防护性能强、故障恢复快可支持Bypass；缺点是对网络的依赖性较强，若网络出现故障可能会影响WAF的正常工作。</li>
</ul>
<img src="https://lizhuo.space/透明代理串接-WAF.png" alt="WAF-透明代理串接部署" style="zoom: 60%;" />
<ul>
<li><strong>反向代理模式</strong> ：早期WAF多采用此模式，其部署在Web服务器前端，客户端请求先经过WAF，由WAF代为转发请求到后端服务器，再将服务器的响应返回给客户端。优点是部署相对简单，且能有效隐藏后端服务器地址等信息，对服务器有较好的保护作用；缺点是可能会成为性能瓶颈，且需要更改网络配置，故障恢复相对较慢。具体可细分为代理模式和牵引模式，主要区别在于映射转发的位置。</li>
</ul>
<img src="https://lizhuo.space/反向代理-WAF.png" alt="WAF-反向代理部署" style="zoom: 67%;" />
<ul>
<li>
<p><strong>旁路监控模式</strong> ：通过在交换机上做服务器端口镜像，将流量复制一份到WAF上，WAF仅对流量进行监控和告警而不阻断，部署时不影响在线业务。此模式优点是不影响现有网络业务，可作为安全监测手段；缺点是<strong>无法直接对攻击流量进行阻断，只能起到事后分析的作用</strong>。</p>
<img src="https://lizhuo.space/旁路监控-WAF.png" alt="WAF-旁路监控模式" style="zoom: 67%;" />
</li>
</ul>
<h5 id="b-当前主流接入方式">B. 当前主流接入方式<a hidden class="anchor" aria-hidden="true" href="#b-当前主流接入方式">#</a></h5>
<p>  当前主流的 WAF 接入方式各有特点，分别为 CNAME 接入、云产品接入和云原生架构接入。CNAME 接入操作简单，适合大多数网站业务，修改通过域名 DNS 解析实现引流；云产品接入则适用于阿里云用户，在云产品控制台添加引流端口到 WAF，无需修改 DNS，降低了配置复杂度；云原生架构接入是 WAF 3.0 的特有方式，采用 SDK 模块化集成，避免流量转发带来的兼容性问题，提升业务性能，简化接入流程。</p>
<ul>
<li><strong>CNAME接入（反向代理模式）</strong>：CNAME 接入是通过<strong>将域名的 DNS 解析指向 WAF 提供的 CNAME 地址</strong>，使 <strong>Web 业务流量被引流到 WAF</strong>。WAF 作为反向代理集群，拦截攻击请求并将正常业务请求转发回源站服务器。它适用于大多数网站的 Web 业务，操作相对简单，只需修改域名的 DNS 解析设置，可以有效隐藏源站 IP，便于集中管理多个域名的流量并实施统一的安全策略。</li>
<li><strong>云产品接入（透明代理模式）</strong>：云产品接入是通过在云产品控制台（如阿里云的 ALB 等）添加引流端口到 WAF，使云产品网关自动改变路由，将 Web 业务流量引导至 WAF。WAF 进行攻击拦截并转发正常请求回源站。它适用于使用阿里云云产品的用户，无需修改 DNS，降低了配置复杂度，减少了因 DNS 变更可能带来的流量中断风险，该接入<strong>适合与云平台应用产品紧密集成的场景</strong>。</li>
<li><strong>云原生架构集成接入</strong>：这是WAF部署模式的重要发展方向，以阿里云WAF 3.0为代表。采用 SDK 模块化的方式将 WAF 集成到云产品的网关中，内嵌在网关中的 SDK 提取流量并进行检测和防护，<strong>WAF 不直接参与流量转发</strong>。它适合对业务性能和稳定性要求较高的场景，尤其是当用户已在使用阿里云的云产品且希望通过更高效的方式实现安全防护时。这种方式<strong>避免了因额外引入 WAF 转发层而可能产生的兼容性和稳定性问题</strong>，提升了业务性能，简化了接入流程，降低了对用户业务的影响。</li>
</ul>
<hr>
<h3 id="6-waf-vs-其它">6. WAF vs 其它<a hidden class="anchor" aria-hidden="true" href="#6-waf-vs-其它">#</a></h3>
<p>  WAF的功能，免不了要与传统安全设备如IDS和IPS有所对比，但从WAF的出现和发展，俨然就是一个“专项特种兵”的模板，因此有其独特优势的同时，短板和局限也是十分明显的。</p>
<h5 id="a-waf-与其他网络安全设备的对比">A. WAF 与其他网络安全设备的对比<a hidden class="anchor" aria-hidden="true" href="#a-waf-与其他网络安全设备的对比">#</a></h5>
<ul>
<li><strong>传统防火墙</strong>：工作在网络层和传输层，侧重源地址、目的地址和端口号的初步检测，无法深入分析 HTTP 流量。</li>
<li><strong>入侵检测系统（IDS）</strong>：部署在内部网络，监控网络安全状况，侧重检测和审计，无法主动防御。</li>
<li><strong>入侵防御系统（IPS）</strong>：基于签名数据库和策略来检查已知漏洞和攻击，适用于保护多种网络协议，但不专用于 HTTP 流量。</li>
</ul>
<h5 id="b-waf-的价值与优势">B. WAF 的价值与优势<a hidden class="anchor" aria-hidden="true" href="#b-waf-的价值与优势">#</a></h5>
<ul>
<li><strong>深度防御</strong>：工作在应用层，能够审计所有 HTTP 流量，提供比传统设备更深入的 Web 应用保护。</li>
<li><strong>灵活性</strong>：可以快速修改规则策略，及时应对不断变化的攻击。</li>
<li><strong>速率限制</strong>：能够快速实施速率限制，有效防止 DDoS 攻击。</li>
</ul>
<h5 id="c-waf-的局限">C. WAF 的局限<a hidden class="anchor" aria-hidden="true" href="#c-waf-的局限">#</a></h5>
<ul>
<li><strong>协议局限</strong>：WAF主要针对HTTP/HTTPS协议，无法过滤其他协议（如FTP、PoP3）的流量。</li>
<li><strong>功能局限</strong>：无法实现传统防火墙的功能，如地址映射、端口转发等网络层和传输层操作。</li>
<li><strong>攻击局限</strong>：主要针对应用层攻击，由于难以理解复杂业务逻辑，无法识别如恶意利用优惠券、外挂抢购等业务逻辑攻击，也无法防御零日攻击和部分复杂的应用层攻击。</li>
<li><strong>防护局限</strong>：不具备防病毒功能，无法检测和清除终端设备上的病毒和恶意软件。</li>
<li><strong>误报和漏报</strong>：尽管是共性问题，但WAF中部署模式的影响可能比较明显。</li>
<li><strong>性能开销</strong>：对HTTP流量的深度检查和过滤会增加请求处理时间，导致延迟，且在处理大量流量时会消耗较多系统资源，影响Web应用性能。</li>
<li><strong>配置和管理复杂</strong>：需要专业知识和经验来合理配置规则，过于严格或宽松都会影响效果，且需要定期更新规则以应对新的攻击方式，增加了维护成本。</li>
</ul>
<hr>
<h3 id="7-主流供应厂商和waf产品">7. 主流供应厂商和WAF产品<a hidden class="anchor" aria-hidden="true" href="#7-主流供应厂商和waf产品">#</a></h3>
<p>  目前市场上的WAF产品种类繁多，涵盖了云WAF、硬件WAF和软件WAF等多种部署模式。云WAF产品如AWS WAF、Akamai Kona Site Defender、Fortinet FortiWeb、Cloudflare WAF等，具有部署便捷、易于扩展和集成等优势，适合各类企业使用。硬件WAF产品如安恒明御Web应用防火墙、长亭雷池(SafeLine)等，适合对安全性要求较高的企业。软件WAF产品如网站安全狗、云锁等，适合中小企业和开发者。各厂商不断推出创新产品和解决方案，以满足不同用户的需求。</p>
<p>  下表是目前比较主流的WAF供应厂商和产品线（这部分借助kimi整理）：</p>
<table>
  <thead>
      <tr>
          <th>公司名称</th>
          <th>简述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>国内</strong></td>
          <td></td>
      </tr>
      <tr>
          <td>深信服</td>
          <td>国内领先的网络安全解决方案提供商，WAF 产品简单易用、高效防护，广泛应用于各类企业及机构。</td>
      </tr>
      <tr>
          <td>绿盟科技</td>
          <td>提供硬件 WAF 产品，在网络入侵防护领域技术深厚，能有效应对各类 Web 攻击。</td>
      </tr>
      <tr>
          <td>启明星辰</td>
          <td>国内知名网络安全企业，硬件 WAF 产品防护能力强、功能丰富，满足金融、能源等行业需求。</td>
      </tr>
      <tr>
          <td>安恒信息</td>
          <td>国内网络安全佼佼者，天穹 Web 应用防火墙硬件产品，提供多方位安全防护服务。</td>
      </tr>
      <tr>
          <td>腾讯云</td>
          <td>提供云 WAF 服务，具备强大 Web 攻击检测能力，支持多种架构及接入方式，满足多行业需求。</td>
      </tr>
      <tr>
          <td>阿里云</td>
          <td>云 WAF 结合多种云服务交付，市场占有率高，提供全面防护功能及灵活付费模式。</td>
      </tr>
      <tr>
          <td><strong>国外</strong></td>
          <td></td>
      </tr>
      <tr>
          <td>Fortinet</td>
          <td>提供硬件和软件形式的 WAF 解决方案，其 FortiWeb 产品采用多层安全方法，防止已知和未知攻击，保护 Web 应用程序和 API，支持物理设备、虚拟机、云实例和容器等多种部署方式。</td>
      </tr>
      <tr>
          <td>Imperva</td>
          <td>提供全面网络安全解决方案，WAF 产品及服务防护能力强、功能丰富，应用于全球大型企业。</td>
      </tr>
      <tr>
          <td>Cloudflare</td>
          <td>全球知名云服务提供商，WAF 服务集成于云平台，具备强大 DDoS 防护及 Web 攻击防护功能。</td>
      </tr>
      <tr>
          <td>Akamai</td>
          <td>提供软件和托管服务形式的 WAF 解决方案，依托全球分布式网络，保障 Web 应用可用性和安全性。</td>
      </tr>
      <tr>
          <td>F5（CloudGuard）</td>
          <td>提供高性能硬件 WAF 设备和软件解决方案，在应用交付和安全领域经验丰富，提供高级防护。</td>
      </tr>
      <tr>
          <td>Barracuda Networks</td>
          <td>提供多种形式的 WAF 解决方案，产品易用且高效，可有效保护 Web 应用免受多种攻击威胁。</td>
      </tr>
  </tbody>
</table>
<table>
  <thead>
      <tr>
          <th style="text-align: left">厂商</th>
          <th style="text-align: center">产品</th>
          <th style="text-align: center">部署模式</th>
          <th style="text-align: left">核心能力</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">AWS</td>
          <td style="text-align: center">AWS WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">基于云的WAF解决方案，与AWS服务集成，提供可扩展和灵活的保护，实时威胁检测和阻止，可自定义规则和策略</td>
      </tr>
      <tr>
          <td style="text-align: left">Akamai</td>
          <td style="text-align: center">Kona Site Defender</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供企业级保护，高级DDoS保护，实时威胁检测和阻止，与Akamai的CDN集成以改善性能，全面的报告和分析</td>
      </tr>
      <tr>
          <td style="text-align: left">Fortinet</td>
          <td style="text-align: center">FortiWeb</td>
          <td style="text-align: center">硬件或虚拟</td>
          <td style="text-align: left">基于AI的威胁检测和阻止，提供硬件和虚拟解决方案，机器人保护和DDoS缓解，全面的报告和分析</td>
      </tr>
      <tr>
          <td style="text-align: left">Cloudflare</td>
          <td style="text-align: center">Cloudflare WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供低延迟、高可用、高可扩展的防护能力，可防止OWASP Top 10等常见攻击，可根据用户自定义规则和Cloudflare智能规则进行灵活配置，可与其他服务集成</td>
      </tr>
      <tr>
          <td style="text-align: left">ModSecurity</td>
          <td style="text-align: center">ModSecurity WAF</td>
          <td style="text-align: center">主机层</td>
          <td style="text-align: left">开源免费，灵活配置，支持多种协议和格式的分析和过滤，可使用OWASP Core Rule Set等标准规则集，也可使用用户自定义规则，还可与其他工具集成</td>
      </tr>
      <tr>
          <td style="text-align: left">阿里云</td>
          <td style="text-align: center">阿里云WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供基于云计算的Web应用防火墙，保护Web应用免受常见黑客攻击技术和安全漏洞的侵害</td>
      </tr>
      <tr>
          <td style="text-align: left">腾讯云</td>
          <td style="text-align: center">T-Sec WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供Web应用防火墙服务，具备Web安全防护和Web威胁智能拦截功能</td>
      </tr>
      <tr>
          <td style="text-align: left">华为云</td>
          <td style="text-align: center">Web应用防火墙 WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供Web应用防火墙服务，保护Web应用的安全</td>
      </tr>
      <tr>
          <td style="text-align: left">安恒信息</td>
          <td style="text-align: center">玄武盾</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供云防护平台，具备Web应用防火墙功能</td>
      </tr>
      <tr>
          <td style="text-align: left">百度智能云</td>
          <td style="text-align: center">云应用防火墙 WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供应用防火墙服务，具备安全漏洞防护和云安全应用防护功能</td>
      </tr>
      <tr>
          <td style="text-align: left">知道创宇</td>
          <td style="text-align: center">创宇盾</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供Web应用防火墙服务，具备政企网站防护、被黑防护、防篡改等功能</td>
      </tr>
      <tr>
          <td style="text-align: left">F5</td>
          <td style="text-align: center">分布式云 WAF</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供分布式云WAF服务</td>
      </tr>
      <tr>
          <td style="text-align: left">奇安信</td>
          <td style="text-align: center">网站卫士</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供Web应用安全防护服务</td>
      </tr>
      <tr>
          <td style="text-align: left">360</td>
          <td style="text-align: center">磐云</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供Web应用防火墙服务</td>
      </tr>
      <tr>
          <td style="text-align: left">网宿科技</td>
          <td style="text-align: center">Web应用防火墙</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供Web应用防火墙服务，具备网站防护和智能边缘安全功能</td>
      </tr>
      <tr>
          <td style="text-align: left">深信服</td>
          <td style="text-align: center">云Web应用防火墙</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供云WAF服务，具备Bot防护和云安全功能</td>
      </tr>
      <tr>
          <td style="text-align: left">绿盟科技</td>
          <td style="text-align: center">网站云防护</td>
          <td style="text-align: center">基于云</td>
          <td style="text-align: left">提供云计算安全产品，具备网站云防护功能</td>
      </tr>
      <tr>
          <td style="text-align: left">启明星辰</td>
          <td style="text-align: center">虚拟化WAF</td>
          <td style="text-align: center">虚拟化</td>
          <td style="text-align: left">提供虚拟WAF服务，具备Web应用安全网关功能</td>
      </tr>
      <tr>
          <td style="text-align: left">长亭科技</td>
          <td style="text-align: center">雷池(SafeLine)</td>
          <td style="text-align: center">硬件</td>
          <td style="text-align: left">下一代Web应用防火墙，提供Web应用防护功能</td>
      </tr>
      <tr>
          <td style="text-align: left">天融信</td>
          <td style="text-align: center">Web应用安全防护系统(TopWAF)</td>
          <td style="text-align: center">硬件</td>
          <td style="text-align: left">提供Web应用安全防护系统服务</td>
      </tr>
      <tr>
          <td style="text-align: left">瑞数信息</td>
          <td style="text-align: center">动态Web应用防火墙（River Safeplus）</td>
          <td style="text-align: center">硬件</td>
          <td style="text-align: left">提供动态Web应用防火墙服务</td>
      </tr>
  </tbody>
</table>
<hr>
<h3 id="写在最后">写在最后<a hidden class="anchor" aria-hidden="true" href="#写在最后">#</a></h3>
<p>  本质上，WAF作为一种专用网络安全技术，在安全防御体系中需要承担特定的责任。用现实世界中安防机构的安防全景图来类比，WAF比较类似一个大门入口处智能安检系统的角色，负责检查进入Web应用的“人员”（HTTP请求），并拦截可疑行为（如SQL注入、XSS攻击）。</p>
<p>  关于安防机构的全景图，我简单设想了一个分层比喻的对应情况，便于理解WAF的角色定位：</p>
<ul>
<li><font size=2><strong>外部防御层</strong>：防火墙（围墙+安检门）+ VPN（加密电梯）</font></li>
<li><font size=2><strong>入口过滤层</strong>：WAF（智能安检系统）</font></li>
<li><font size=2><strong>内部监测层</strong>：IDS（摄像头）+ IPS（安保人员）+ HIDS（保镖）</font></li>
<li><font size=2><strong>数据保护层</strong>：加密技术（保险柜）+ 网络隔离（防火分区）</font></li>
<li><font size=2><strong>高级防护层</strong>：蜜罐（诱饵房间）+ 零信任（人脸识别门禁）+ SIEM（指挥中心）</font></li>
</ul>
<h3 id="refer">Refer<a hidden class="anchor" aria-hidden="true" href="#refer">#</a></h3>
<ul>
<li>
<p><font size=2>WAF相关专栏： <a href="https://mp.weixin.qq.com/s/CXTedk3BAVNt0elOsaFccA">安全文章相关</a></font></p>
</li>
<li>
<p><font size=2><a href="https://zhuanlan.zhihu.com/p/307350082">WAF的部署方式 - 知乎</a></font></p>
</li>
<li>
<p><font size=2><a href="https://blog.csdn.net/shuicarry66/article/details/144719161">什么是Web应用防火墙，简称：WAF（Web Application Firewall）_waf应用安全网关是什么-CSDN博客</a></font></p>
</li>
<li>
<p><font size=2><a href="https://blog.csdn.net/weixin_61178890/article/details/145291264">WAF（Web应用防火墙）的关键技术分析_waf路由模式-CSDN博客</a></font></p>
</li>
<li>
<p><font size=2><a href="https://help.aliyun.com/zh/waf/product-overview/product-overview-home">WAF 2.0和WAF 3.0是什么关系、有什么区别、如何快速使用_Web应用防火墙(WAF)-阿里云帮助中心</a></font></p>
</li>
<li>
<p><font size=2><a href="https://www.freebuf.com/company-information/286013.html">WAF基本原理与部署方式，建议收藏！ - FreeBuf网络安全行业门户</a></font></p>
</li>
<li>
<p><font size=2>Kimi：<a href="https://kimi.moonshot.cn/">Kimi - 会推理解析，能深度思考的AI助手</a></font></p>
</li>
</ul>


  </div>

  <footer class="post-footer">
    
<nav class="paginav">
  <a class="prev" href="https://lz0o0.github.io/zh/posts/life/%E6%AF%95%E4%B8%9A%E7%AD%94%E8%BE%A9%E6%97%81%E5%90%AC%E7%BA%AA%E8%A6%81/">
    <span class="title">« Last Page</span>
    <br>
    <span>毕业答辩旁听纪要</span>
  </a>
  <a class="next" href="https://lz0o0.github.io/zh/posts/nice-techs/mcp-%E6%A8%A1%E5%9E%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E5%8D%8F%E8%AE%AE%E5%85%A8%E8%A7%A3/">
    <span class="title">Next Page »</span>
    <br>
    <span>MCP 模型上下文协议全解</span>
  </a>
</nav>

  </footer>
<script src="https://utteranc.es/client.js"
        repo="lz0o0/lz0o0.github.io"
        issue-term="pathname"
        theme="icy-dark"
        crossorigin="anonymous"
        async>
</script>




</article>
    </main>
    
<footer class="footer">
        <span><a href="https://lz0o0.github.io/">©2024  Le blog de Lz0o0</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
